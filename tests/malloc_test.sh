# **************************************************************************** #
#                                                                              #
#                                                         :::      ::::::::    #
#    malloc_test.sh                                     :+:      :+:    :+:    #
#                                                     +:+ +:+         +:+      #
#    By: tmatis <tmatis@student.42.fr>              +#+  +:+       +#+         #
#                                                 +#+#+#+#+#+   +#+            #
#    Created: 2021/05/21 13:22:03 by tmatis            #+#    #+#              #
#    Updated: 2021/05/21 15:31:47 by tmatis           ###   ########.fr        #
#                                                                              #
# **************************************************************************** #

fail_list="5668 2607 4605 2023 4432 958 5832 2347 2656 1771 1005 685 60 2808 2665 2005 800 400 1348 3991 3861 1472 4316 2779 1706 5902 2120 3283 3007 0 2241 410 2839 2965 587 192 829 2798 5666 4052 5711 2323 3803 4321 1920 2317 289 2658 5703 2191 3867 5309 3179 4694 5237 1782 1228 5881 4788 3503 3823 5014 1492 1940 4020 761 4723 4846 3664 3460 1971 135 3199 2388 184 459 2660 4608 3930 5099 3222 589 4879 2393 3039 4860 4359 366 5975 1408 5894 1686 2730 3569 1599 2984 4645 4502 1201 5128 1079 1009 2696 5189 2900 252 4229 2225 3352 5197 1762 5449 4806 3231 933 2861 4182 5316 248 5477 3082 1458 406 2387 4591 422 2315 2327 29 2991 3929 3736 4007 1679 4739 929 270 3614 1282 1669 732 2478 5342 2406 4890 4629 4724 1673 232 5255 1549 3516 4692 4885 556 5545 1593 4863 1024 3413 1291 5608 4612 5607 1843 4387 5863 791 981 2584 3884 5932 4609 4131 2090 5395 3037 4738 2249 3517 765 2652 5509 5848 1984 2712 1525 249 3616 2593 540 960 353 1830 4654 4079 2852 4909 50 5629 3822 5381 1968 2994 885 4523 2084 4679 4004 4534 4725 5580 602 5337 3518 2516 1521 2136 381 5017 603 2959 597 362 3184 5307 1811 4337 1604 4360 2739 861 2427 1617 267 2078 327 2443 4168 2375 3314 4763 4573 5273 1151 1732 4718 5082 3240 3738 1827 4133 3085 5452 147 5785 3442 472 5623 4294 5517 4870 4891 1824 1124 935 1294 1994 4586 3441 1501 860 1369 3386 2195 2643 771 4668 1204 3863 1375 2029 828 2619 3239 297 2967 565 5692 4354 2272 5887 5377 3660 2525 4207 3548 1564 1315 1292 2240 2646 334 3480 3125 1698 2886 5292 760 3078 5193 3044 3608 5560 2705 942 4579 2083 4765 1129 1849 1869 5417 3924 5605 3680 3301 3272 220 5921 4486 883 1406 586 5654 5420 5031 1308 5693 2870 3167 4035 2324 5004 2127 5725 4552 4969 4244 1939 4747 266 2165 2382 4292 2763 1178 5111 2093 4487 2616 5328 2892 4286 1585 168 5344 1922 3678 2668 3006 3787 1462 5899 2182 1358 5536 3452 4344 2484 3600 3756 2811 2463 2878 1087 3131 4423 687 4425 1155 4170 5098 5168 1639 5901 2164 3117 5139 3610 2339 4619 4544 4933 5754 2801 4478 5733 875 4420 972 333 5513 2378 4014 1696 3484 3354 2764 809 1785 5418 5348 3953 5245 5216 997 4982 5912 2941 2558 4398 4475 1188 712 215 2756 1598 3005 4990 1888 976 4034 701 695 5968 5599 3692 3249 5870 4438 341 751 5925 2390 4049 2936 2304 4250 2883 1405 3649 3196 1863 593 986 6000 3267 2551 3449 3356 3463 2172 4178 5388 5967 666 789 2187 3857 4528 3968 2047 3931 3676 4926 4887 1936 2647 4895 3359 581 2281 2557 3310 2467 1419 3194 3363 3679"

error=0

rm -rf ./logs
mkdir -p ./logs
i=0
for fail_number in $fail_list
do
    cd ./malloc_fail/
    clang -Wall -Werror -Wextra -g -c my_malloc.c -D FAIL=$fail_number && ar -rcs libfail.a my_malloc.o
    rm my_malloc.o
    cd ..
	make -sC ../ malloc_test &> /dev/null
	mkdir ./sandbox
	../malloc_test < parts/large_test.sh > /dev/null 2>> ./logs/malloc_fail.log
	return_value=$?
	if [ $return_value -gt 130 ]
	then
	    printf "\033[0;31m$fail_number\033[m ratio: \033[0;31m[KO]\033[m  (check tests/logs/malloc_fail.log)\n"
		error=1
		rm -rf ./sandbox
		rm -rf ../malloc_test
		break
	fi
	((i = i + 1))
	rm -rf ./sandbox
	rm -rf ../malloc_test
done
printf "\033[0;32m$i\033[m test passed\n"
if [ $error -eq 0 ]
then
	printf "Protection \033[0;32m[OK]\033[m\n"
fi
rm 'malloc_fail/libfail.a'
exit $error
